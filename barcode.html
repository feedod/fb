---
layout: default
---

<main class="container" x-data="barcodeApp">
  <h1>Ð“ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ð¾Ð² EAN</h1>

  <div style="display: flex; gap: 0.5em; margin-bottom: 0.5em;">
    <input
      type="number"
      id="barcodeInput"
      placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 8 Ð¸Ð»Ð¸ 13 Ñ†Ð¸Ñ„Ñ€ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½ÑƒÑŽ)"
      x-model="inputValue"
      @input="validateEAN()"
      aria-describedby="hintText"
      :class="{'error-field': error}"
      style="flex: 1; padding: 0.6em; font-size: 1em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;"
    >
    <button
      @click="scanQR()"
      style="padding: 0.6em; font-size: 1em; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white; cursor: pointer;"
      type="button"
    >
      ðŸ“·
    </button>
  </div>

  <p
    id="hintText"
    :style="{ color: error ? 'red' : '#555' }"
    style="font-size: 0.9em; margin-top: 0.2em;"
    x-text="getHint()"
    role="status"
    aria-live="polite"
  ></p>

  <p>
    <button
      @click="handleGenerate"
      :disabled="error || !inputValue"
      :class="{'disabled-button': error || !inputValue}"
      style="width: 100%; padding: 0.7em; font-size: 1em; cursor: pointer; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white;"
      type="button"
    >
      Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
    </button>
  </p>

  <div style="text-align: center; margin-top: 1em;">
    <img
      x-show="barcodeUrl"
      :src="barcodeUrl"
      style="width: 100%; max-width: 600px; height: 150px; display: inline-block;"
    >
  </div>
</main>

<style>
  .error-field { border-color: red !important; }
  .disabled-button { opacity: 0.6; cursor: not-allowed; }
</style>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
document.addEventListener("alpine:init", () => {
  Alpine.data("barcodeApp", () => ({
    inputValue: "",
    barcodeUrl: "",
    error: false,
    errorMessage: "",

    getHint() {
      if (!this.inputValue) return "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ð°, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½ÑƒÑŽ Ñ†Ð¸Ñ„Ñ€Ñƒ.";
      if (this.error) return this.errorMessage;
      const len = this.inputValue.length;
      if (![8,13].includes(len)) return "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ†Ð¸Ñ„Ñ€: 8 Ð´Ð»Ñ EAN-8 Ð¸Ð»Ð¸ 13 Ð´Ð»Ñ EAN-13.";
      return "ÐšÐ¾Ð´ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸.";
    },

    computeCheckDigit(number, type) {
      const digits = number.split("").map(d => parseInt(d, 10));
      let sum = 0;
      if (type === "ean8") {
        for (let i = 0; i < 7; i++) sum += (i % 2 === 0 ? digits[i] * 3 : digits[i]);
      } else if (type === "ean13") {
        for (let i = 0; i < 12; i++) sum += (i % 2 === 0 ? digits[i] : digits[i] * 3);
      }
      return (10 - (sum % 10)) % 10 + "";
    },

    validateEAN() {
      const sanitized = this.inputValue.replace(/\D/g, "");
      if (!sanitized) {
        this.error = true;
        this.errorMessage = "ÐŸÐ¾Ð»Ðµ Ð¿ÑƒÑÑ‚Ð¾Ðµ. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ†Ð¸Ñ„Ñ€Ñ‹.";
        return;
      }
      if (![8,13].includes(sanitized.length)) {
        this.error = true;
        this.errorMessage = "ÐÐµÐ²ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ†Ð¸Ñ„Ñ€. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 8 Ð¸Ð»Ð¸ 13 Ñ†Ð¸Ñ„Ñ€.";
        return;
      }
      const type = sanitized.length === 8 ? "ean8" : "ean13";
      const digits = sanitized.slice(0, sanitized.length - 1);
      const checkDigit = sanitized[sanitized.length - 1];
      const expected = this.computeCheckDigit(digits, type);
      if (checkDigit !== expected) {
        this.error = true;
        this.errorMessage = `ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ð°Ñ Ñ†Ð¸Ñ„Ñ€Ð° Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°. ÐžÐ¶Ð¸Ð´Ð°Ð»Ð¾ÑÑŒ: ${expected}`;
      } else {
        this.error = false;
        this.errorMessage = "";
      }
    },

    async handleGenerate() {
      if (this.error) return;

      try {
        const sanitized = this.inputValue.replace(/\D/g, "");
        const type = sanitized.length === 8 ? "ean8" : "ean13";
        const screenWidth = Math.min(window.innerWidth * 0.95, 600);
        const height = 150;
        const url = `https://quickchart.io/barcode?type=${type}&text=${encodeURIComponent(sanitized)}&width=${Math.floor(screenWidth)}&height=${height}`;
        const response = await fetch(url, { method: "HEAD" });
        if (!response.ok) throw new Error("Ð¡ÐµÑ€Ð²Ð¸Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");

        this.barcodeUrl = url;
        this.inputValue = "";
        this.error = false;
        this.errorMessage = "";
      } catch (err) {
        this.error = true;
        this.barcodeUrl = "";
        this.errorMessage = err.message || "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸.";
      }
    },

    scanQR() {
      if (!window.Telegram?.WebApp || !window.Telegram.WebApp.WebAppScanner) {
        this.error = true;
        this.errorMessage = "Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð² ÑÑ‚Ð¾Ð¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸.";
        return;
      }

      const tg = window.Telegram.WebApp;
      tg.WebAppScanner.scanQrCode()
        .then(result => {
          if (!result) return;
          const sanitized = result.replace(/\D/g, "");
          if (![8,13].includes(sanitized.length)) {
            this.error = true;
            this.errorMessage = "ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ QR ÐºÐ¾Ð´ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ð¹ EAN-8 Ð¸Ð»Ð¸ EAN-13.";
            return;
          }
          this.inputValue = sanitized;
          this.validateEAN();
          if (!this.error) this.handleGenerate();
        })
        .catch(() => {
          this.error = true;
          this.errorMessage = "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´.";
        });
    }
  }));
});

if (window.Telegram?.WebApp) {
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.BackButton.show();
  tg.BackButton.onClick(() => window.location.href = "index.html");
  tg.CloseButton.hide();
}
</script>