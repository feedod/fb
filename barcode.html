---
layout: default
---

<main class="container" x-data="barcodeApp">
  <h1>Генератор штрихкодов EAN</h1>

  <p>
    <input
      type="text"
      id="barcodeInput"
      placeholder="Введите 8 или 13 цифр (включая контрольную)"
      inputmode="numeric"
      pattern="[0-9]*"
      maxlength="13"
      x-model.trim="inputValue"
      @input="validateEAN"
      aria-describedby="hintText"
      :class="{'error-field': error}"
      class="input-field"
    >
  </p>

  <p
    id="hintText"
    x-text="getHint()"
    role="status"
    aria-live="polite"
    :class="error ? 'hint-text error' : 'hint-text normal'"
  ></p>

  <p>
    <button
      @click="handleGenerate"
      :disabled="error || !inputValue"
      :class="{'disabled-button': error || !inputValue}"
      class="primary-btn"
    >
      Сгенерировать
    </button>
  </p>

  <div class="preview">
    <template x-if="barcodeUrl">
      <div class="code-block">
        <img :src="barcodeUrl" alt="Штрихкод" class="barcode-img">
        <button @click="downloadImage(barcodeUrl, 'barcode.png')" class="download-btn">
          Скачать штрихкод
        </button>
      </div>
    </template>

    <template x-if="qrCodeUrl">
      <div class="code-block">
        <img :src="qrCodeUrl" alt="QR-код" class="qr-img">
        <button @click="downloadImage(qrCodeUrl, 'qrcode.png')" class="download-btn">
          Скачать QR-код
        </button>
      </div>
    </template>
  </div>
</main>

<style>
  .input-field {
    width: 100%;
    padding: 0.6em;
    font-size: 1em;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  .error-field { border-color: red !important; }
  .hint-text { font-size: 0.9em; margin-top: 0.2em; }
  .hint-text.normal { color: #555; }
  .hint-text.error { color: red; }
  .primary-btn {
    width: 100%;
    padding: 0.7em;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #007bff;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }
  .primary-btn:hover:enabled { background-color: #0069d9; }
  .disabled-button { opacity: 0.6; cursor: not-allowed; }
  .preview { text-align: center; margin-top: 1em; }
  .code-block { margin-bottom: 1.5em; }
  .barcode-img {
    width: 100%;
    max-width: 600px;
    height: 150px;
    display: inline-block;
    margin-bottom: 0.5em;
  }
  .qr-img {
    width: 200px;
    height: 200px;
    display: inline-block;
    margin-bottom: 0.5em;
  }
  .download-btn {
    padding: 0.6em 1.2em;
    font-size: 0.9em;
    border-radius: 4px;
    border: 1px solid #28a745;
    background-color: #28a745;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }
  .download-btn:hover { background-color: #218838; }
</style>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
document.addEventListener("alpine:init", () => {
  Alpine.data("barcodeApp", () => ({
    inputValue: "",
    barcodeUrl: "",
    qrCodeUrl: "",
    error: false,
    errorMessage: "",

    getHint() {
      if (!this.inputValue) return "Введите 8 или 13 цифр для генерации.";
      if (this.error) return this.errorMessage;
      const len = this.inputValue.length;
      if (![8, 13].includes(len)) return "Должно быть 8 или 13 цифр.";
      return "Код готов к генерации.";
    },

    computeCheckDigit(number, type) {
      const digits = number.split("").map(d => parseInt(d, 10));
      let sum = 0;
      if (type === "ean8") {
        for (let i = 0; i < 7; i++) sum += (i % 2 === 0 ? digits[i] * 3 : digits[i]);
      } else if (type === "ean13") {
        for (let i = 0; i < 12; i++) sum += (i % 2 === 0 ? digits[i] : digits[i] * 3);
      }
      return (10 - (sum % 10)) % 10 + "";
    },

    validateEAN() {
      try {
        const sanitized = this.inputValue.replace(/\D/g, "");
        if (this.inputValue !== sanitized) this.inputValue = sanitized;

        if (!sanitized) {
          this.error = true;
          this.errorMessage = "Поле пустое. Введите только цифры.";
          return;
        }

        if (![8, 13].includes(sanitized.length)) {
          this.error = true;
          this.errorMessage = "Неверная длина. Нужно 8 или 13 цифр.";
          return;
        }

        const type = sanitized.length === 8 ? "ean8" : "ean13";
        const digits = sanitized.slice(0, -1);
        const checkDigit = sanitized[sanitized.length - 1];
        const expected = this.computeCheckDigit(digits, type);

        if (checkDigit !== expected) {
          this.error = true;
          this.errorMessage = `Некорректная контрольная цифра. Ожидалось: ${expected}.`;
        } else {
          this.error = false;
          this.errorMessage = "";
        }
      } catch (e) {
        this.error = true;
        this.errorMessage = "Ошибка при проверке кода.";
      }
    },

    async handleGenerate() {
      if (this.error || !this.inputValue) return;

      try {
        const sanitized = this.inputValue.replace(/\D/g, "");
        const type = sanitized.length === 8 ? "ean8" : "ean13";

        const screenWidth = Math.min(window.innerWidth * 0.95, 600);
        const height = 150;

        const barcodeUrl = `https://quickchart.io/barcode?type=${type}&text=${encodeURIComponent(sanitized)}&width=${Math.floor(screenWidth)}&height=${height}`;
        const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(sanitized)}&size=200`;

        const [barcodeResp, qrResp] = await Promise.allSettled([
          fetch(barcodeUrl, { method: "HEAD" }),
          fetch(qrUrl, { method: "HEAD" })
        ]);

        if (barcodeResp.status !== "fulfilled" || !barcodeResp.value.ok) {
          throw new Error("Ошибка генерации штрихкода.");
        }
        if (qrResp.status !== "fulfilled" || !qrResp.value.ok) {
          throw new Error("Ошибка генерации QR-кода.");
        }

        this.barcodeUrl = barcodeUrl;
        this.qrCodeUrl = qrUrl;
        this.error = false;
        this.errorMessage = "";
      } catch (err) {
        this.error = true;
        this.barcodeUrl = "";
        this.qrCodeUrl = "";
        this.errorMessage = err.message || "Неизвестная ошибка при генерации.";
      }
    },

    async downloadImage(url, filename) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("Ошибка загрузки изображения.");
        const blob = await resp.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        alert(e.message || "Ошибка скачивания файла.");
      }
    }
  }));
});

if (window.Telegram?.WebApp) {
  try {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.BackButton.show();
    tg.BackButton.onClick(() => window.location.href = "index.html");
    tg.CloseButton.hide();
  } catch (e) {
    console.error("Ошибка инициализации Telegram WebApp:", e);
  }
}
</script>