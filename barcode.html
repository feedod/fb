---
layout: default
---

<main class="container" x-data="barcodeApp">
  <h1>Генератор штрихкодов</h1>

  <!-- Ввод данных пользователем -->
  <p>
    <input
      type="number"
      placeholder="Введите цифры для EAN-8 или EAN-13"
      x-model="inputValue"
      @input="inputValue = inputValue.replace(/\D/g,'')" 
      style="width: 100%; padding: 0.6em; font-size: 1em; box-sizing: border-box;"
    >
  </p>

  <!-- Подсказка пользователю о длине кода -->
  <p style="color: #555; font-size: 0.9em; margin-top: 0.2em;" x-text="getHint()"></p>

  <!-- Ошибки при генерации -->
  <p
    x-show="error"
    x-text="errorMessage"
    style="color: red; font-size: 0.9em; display: none;"
  ></p>

  <!-- Кнопка генерации штрихкода -->
  <p>
    <button
      @click="handleGenerate"
      style="width: 100%; padding: 0.7em; font-size: 1em; cursor: pointer;"
    >
      Сгенерировать
    </button>
  </p>

  <!-- Штрихкод -->
  <div style="text-align: center; margin-top: 1em;">
    <img
      x-show="barcodeUrl"
      :src="barcodeUrl"
      style="width: 100%; max-width: 600px; height: 150px; display: inline-block;"
    >
  </div>
</main>

<!-- Alpine.js для реактивности -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<!-- Telegram WebApp API -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
document.addEventListener("alpine:init", () => {
  Alpine.data("barcodeApp", () => ({
    inputValue: "",     // Значение поля ввода
    barcodeUrl: "",     // URL сгенерированного штрихкода
    error: false,       // Флаг ошибки
    errorMessage: "",   // Текст ошибки

    /**
     * Подсказка пользователю о количестве цифр
     */
    getHint() {
      const len = this.inputValue.length;
      if (len === 0) return "Введите цифры для генерации штрихкода";
      if (len <= 7) return "Для EAN-8 введите 7 цифр (контрольная цифра добавится автоматически)";
      if (len <= 12) return "Для EAN-13 введите 12 цифр (контрольная цифра добавится автоматически)";
      if (len === 8) return "EAN-8 готово к генерации";
      if (len === 13) return "EAN-13 готово к генерации";
      return "Введите корректное количество цифр для EAN-8 или EAN-13";
    },

    /**
     * Вычисление контрольной цифры для EAN-8 или EAN-13
     * @param {string} number - код без контрольной цифры
     * @param {string} type - 'ean8' или 'ean13'
     * @returns {string} контрольная цифра
     */
    computeCheckDigit(number, type) {
      const digits = number.split("").map(d => parseInt(d, 10));
      let sum = 0;
      if (type === "ean8") {
        for (let i = 0; i < 7; i++) sum += (i % 2 === 0 ? digits[i] * 3 : digits[i]);
      } else if (type === "ean13") {
        for (let i = 0; i < 12; i++) sum += (i % 2 === 0 ? digits[i] : digits[i] * 3);
      }
      const check = (10 - (sum % 10)) % 10;
      return check.toString();
    },

    /**
     * Генерация штрихкода через API QuickChart
     * Автоматически добавляет контрольную цифру, очищает поле после успешной генерации
     */
    async handleGenerate() {
      try {
        const sanitized = this.inputValue.replace(/\D/g, ""); // Только цифры
        if (!sanitized) {
          this.error = true;
          this.errorMessage = "Поле не может быть пустым";
          this.barcodeUrl = "";
          return;
        }

        let barcodeType = "";
        let numberToEncode = "";

        // Обработка всех допустимых длин EAN-8 / EAN-13
        if (sanitized.length === 7) {
          barcodeType = "ean8";
          numberToEncode = sanitized + this.computeCheckDigit(sanitized, barcodeType);
        } else if (sanitized.length === 8) {
          barcodeType = "ean8";
          numberToEncode = sanitized;
        } else if (sanitized.length === 12) {
          barcodeType = "ean13";
          numberToEncode = sanitized + this.computeCheckDigit(sanitized, barcodeType);
        } else if (sanitized.length === 13) {
          barcodeType = "ean13";
          numberToEncode = sanitized;
        } else {
          this.error = true;
          this.errorMessage = "Введите корректное количество цифр для EAN-8 или EAN-13";
          this.barcodeUrl = "";
          return;
        }

        this.error = false;
        this.errorMessage = "";

        // Динамическая ширина для гарантированной читаемости штрихов
        const screenWidth = Math.min(window.innerWidth * 0.95, 600);
        const minBarWidth = 2; // минимальная ширина полосы
        const totalBars = numberToEncode.length * 7; // ориентировочное количество полос
        const width = Math.max(screenWidth, totalBars * minBarWidth);
        const height = 150;

        const url = `https://quickchart.io/barcode?type=${barcodeType}&text=${encodeURIComponent(numberToEncode)}&width=${Math.floor(width)}&height=${height}`;
        const response = await fetch(url, { method: "HEAD" });
        if (!response.ok) throw new Error("Не удалось сгенерировать штрихкод, попробуйте ещё раз");

        this.barcodeUrl = url;
        this.inputValue = ""; // Очистка поля после успешной генерации
      } catch (err) {
        this.error = true;
        this.barcodeUrl = "";
        this.errorMessage = err.message || "Произошла ошибка при генерации штрихкода";
      }
    }
  }));
});

// Настройка Telegram WebApp кнопки «Назад»
if (window.Telegram?.WebApp) {
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  tg.BackButton.show();
  tg.BackButton.onClick(() => window.location.href = "index.html");
  tg.CloseButton.hide();
}
</script>