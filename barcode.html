---
layout: default
---

<main class="container" x-data="barcodeApp">
  <h1>Генератор штрихкодов EAN</h1>

  <div style="display: flex; gap: 0.5em; margin-bottom: 0.5em;">
    <input
      type="number"
      id="barcodeInput"
      placeholder="Введите 8 или 13 цифр (включая контрольную)"
      x-model="inputValue"
      @input="validateEAN()"
      aria-describedby="hintText"
      :class="{'error-field': error}"
      style="flex: 1; padding: 0.6em; font-size: 1em; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;"
    >
    <button
      @click="scanQR()"
      style="padding: 0.6em; font-size: 1em; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white; cursor: pointer;"
      type="button"
    >
      📷
    </button>
  </div>

  <p
    id="hintText"
    :style="{ color: error ? 'red' : '#555' }"
    style="font-size: 0.9em; margin-top: 0.2em;"
    x-text="getHint()"
    role="status"
    aria-live="polite"
  ></p>

  <p>
    <button
      @click="handleGenerate"
      :disabled="error || !inputValue"
      :class="{'disabled-button': error || !inputValue}"
      style="width: 100%; padding: 0.7em; font-size: 1em; cursor: pointer; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white;"
      type="button"
    >
      Сгенерировать
    </button>
  </p>

  <div style="text-align: center; margin-top: 1em;">
    <img
      x-show="barcodeUrl"
      :src="barcodeUrl"
      style="width: 100%; max-width: 600px; height: 150px; display: inline-block;"
    >
  </div>
</main>

<style>
  .error-field { border-color: red !important; }
  .disabled-button { opacity: 0.6; cursor: not-allowed; }
</style>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
document.addEventListener("alpine:init", () => {
  Alpine.data("barcodeApp", () => ({
    inputValue: "",
    barcodeUrl: "",
    error: false,
    errorMessage: "",

    getHint() {
      if (!this.inputValue) return "Введите цифры для генерации штрихкода, включая контрольную цифру.";
      if (this.error) return this.errorMessage;
      const len = this.inputValue.length;
      if (![8,13].includes(len)) return "Введите правильное количество цифр: 8 для EAN-8 или 13 для EAN-13.";
      return "Код готов к генерации.";
    },

    computeCheckDigit(number, type) {
      const digits = number.split("").map(d => parseInt(d, 10));
      let sum = 0;
      if (type === "ean8") {
        for (let i = 0; i < 7; i++) sum += (i % 2 === 0 ? digits[i] * 3 : digits[i]);
      } else if (type === "ean13") {
        for (let i = 0; i < 12; i++) sum += (i % 2 === 0 ? digits[i] : digits[i] * 3);
      }
      return (10 - (sum % 10)) % 10 + "";
    },

    validateEAN() {
      const sanitized = this.inputValue.replace(/\D/g, "");
      if (!sanitized) {
        this.error = true;
        this.errorMessage = "Поле пустое. Пожалуйста, введите цифры.";
        return;
      }
      if (![8,13].includes(sanitized.length)) {
        this.error = true;
        this.errorMessage = "Неверное количество цифр. Введите 8 или 13 цифр.";
        return;
      }
      const type = sanitized.length === 8 ? "ean8" : "ean13";
      const digits = sanitized.slice(0, sanitized.length - 1);
      const checkDigit = sanitized[sanitized.length - 1];
      const expected = this.computeCheckDigit(digits, type);
      if (checkDigit !== expected) {
        this.error = true;
        this.errorMessage = `Контрольная цифра некорректна. Ожидалось: ${expected}`;
      } else {
        this.error = false;
        this.errorMessage = "";
      }
    },

    async handleGenerate() {
      if (this.error) return;

      try {
        const sanitized = this.inputValue.replace(/\D/g, "");
        const type = sanitized.length === 8 ? "ean8" : "ean13";
        const screenWidth = Math.min(window.innerWidth * 0.95, 600);
        const height = 150;
        const url = `https://quickchart.io/barcode?type=${type}&text=${encodeURIComponent(sanitized)}&width=${Math.floor(screenWidth)}&height=${height}`;
        const response = await fetch(url, { method: "HEAD" });
        if (!response.ok) throw new Error("Сервис генерации временно недоступен. Попробуйте позже.");

        this.barcodeUrl = url;
        this.inputValue = "";
        this.error = false;
        this.errorMessage = "";
      } catch (err) {
        this.error = true;
        this.barcodeUrl = "";
        this.errorMessage = err.message || "Произошла неизвестная ошибка при генерации.";
      }
    },

    scanQR() {
      if (!window.Telegram?.WebApp || !window.Telegram.WebApp.WebAppScanner) {
        this.error = true;
        this.errorMessage = "Сканирование недоступно в этом окружении.";
        return;
      }

      const tg = window.Telegram.WebApp;
      tg.WebAppScanner.scanQrCode()
        .then(result => {
          if (!result) return;
          const sanitized = result.replace(/\D/g, "");
          if (![8,13].includes(sanitized.length)) {
            this.error = true;
            this.errorMessage = "Отсканированный QR код не содержит допустимый EAN-8 или EAN-13.";
            return;
          }
          this.inputValue = sanitized;
          this.validateEAN();
          if (!this.error) this.handleGenerate();
        })
        .catch(() => {
          this.error = true;
          this.errorMessage = "Не удалось отсканировать QR код.";
        });
    }
  }));
});

if (window.Telegram?.WebApp) {
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.BackButton.show();
  tg.BackButton.onClick(() => window.location.href = "index.html");
  tg.CloseButton.hide();
}
</script>